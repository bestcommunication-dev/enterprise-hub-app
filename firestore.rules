/**
 * @fileoverview Firestore Security Rules for the Enterprise Hub application.
 *
 * Core Philosophy:
 * This ruleset implements a role-based access control (RBAC) model, with path-based ownership for user-related data.
 * It leverages structural segregation to manage data with different access requirements.  Authorization decisions are
 * based on the authenticated user's UID (`request.auth.uid`) and, where appropriate, document ownership.
 *
 * Data Structure:
 * - /clients/{clientId}: Stores client data. Accessible by Back-Office and Admin. Agents can view.
 * - /contracts/{contractId}: Stores contract data. Accessible by Back-Office and Admin.
 * - /users/{userId}/commissions/{commissionId}: Stores commissions for agents. Admin can view all. Back-office can flag.
 * - /users/{userId}: Stores user data, including role assignments.
 * - /roles/{roleId}: Stores role definitions.
 * - /permissions/{permissionId}: Stores permission definitions.
 * - /mail/{mailId}: Stores email documents, create accessible by authenticated users.
 *
 * Key Security Decisions:
 * - User listing is not explicitly denied but depends on access to user documents.
 * - Roles and permissions are stored in dedicated collections for RBAC.
 * - The rules enforce a strict separation of concerns, with clear access patterns for each collection.
 * - Data validation is limited to authorization-critical fields for prototyping speed.
 *
 * Denormalization for Authorization:
 * - No denormalization needed because role assignments are stored directly in the user document, so no extra reads from role collection are needed.
 *
 * Structural Segregation:
 * - Different collections are used based on access needs (e.g., private user subcollections vs. public top-level collections).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Verifies user authentication.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Enforces document ownership.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the existing owner of the document.
     * @path N/A (Helper Function)
     * @allow N/A (Helper Function)
     * @deny N/A (Helper Function)
     * @principle Enforces document ownership and existence for updates and deletes.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for the /clients collection.
     * @path /clients/{clientId}
     * @allow (create) Back-Office user creates a client.
     * @deny (create) Agent attempts to create a client.
     * @principle Enforces role-based access control for client creation.
     */
    match /clients/{clientId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Implement role check for Back-Office and Admin
      allow update: if false; // TODO: Implement role check for Back-Office and Admin
      allow delete: if false; // TODO: Implement role check for Back-Office and Admin
    }

    /**
     * @description Rules for the /contracts collection.
     * @path /contracts/{contractId}
     * @allow (create) Back-Office user creates a contract.
     * @deny (create) Agent attempts to create a contract.
     * @principle Enforces role-based access control for contract creation.
     */
    match /contracts/{contractId} {
      allow get: if true;
      allow list: if true;
      allow create: if false; // TODO: Implement role check for Back-Office and Admin
      allow update: if false; // TODO: Implement role check for Back-Office and Admin
      allow delete: if false; // TODO: Implement role check for Back-Office and Admin
    }

    /**
     * @description Rules for the /users/{userId}/commissions collection.
     * @path /users/{userId}/commissions/{commissionId}
     * @allow (get) Admin user views any commission.
     * @deny (get) Agent attempts to view another agent's commission.
     * @principle Enforces ownership for agents and role-based access for admins.
     */
    match /users/{userId}/commissions/{commissionId} {
      allow get: if isOwner(userId); // Owner can read the commission
      allow list: if isOwner(userId);
      allow create: if isOwner(userId); // Assuming agent can create their own commission
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users collection.
     * @path /users/{userId}
     * @allow (create) User creates their own profile.
     * @deny (create) User attempts to create another user's profile.
     * @principle Enforces self-creation and ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /roles collection.
     * @path /roles/{roleId}
     * @allow (get) Any authenticated user can read role definitions.
     * @deny (create) No one can create roles through the client.
     * @principle Restricts role creation to backend services.
     */
    match /roles/{roleId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /permissions collection.
     * @path /permissions/{permissionId}
     * @allow (get) Any authenticated user can read permission definitions.
     * @deny (create) No one can create permissions through the client.
     * @principle Restricts permission creation to backend services.
     */
    match /permissions/{permissionId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the /mail collection used by the Trigger Email extension.
     * @path /mail/{mailId}
     * @allow (create) Any authenticated user can create a mail document.
     * @deny (read) No client-side reads or writes allowed after creation.
     */
    match /mail/{mailId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }
  }
}
